<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>MicroBlocks 开发笔记 - 夜行人</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="种瓜" /><meta name="description" content="前言 记录我在开发 MicroBlocks 过程中积累的知识和技巧。 主要分为三个部分: MicroBlocks library(积木库) MicroBlocks VM(虚拟机) MicroBlocks IDE(图形化编程环境) MicroBlocks libra" /><meta name="keywords" content="education, programming, Technology" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="http://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/microblocks-dev-notes/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.69e0bbe2419d9b0efbdcc1d3b4338bba03a6f6789ae2832bc1af58e5b2757470.css" rel="stylesheet">
<link rel="stylesheet" href="/post/img/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="MicroBlocks 开发笔记" />
<meta property="og:description" content="前言 记录我在开发 MicroBlocks 过程中积累的知识和技巧。 主要分为三个部分: MicroBlocks library(积木库) MicroBlocks VM(虚拟机) MicroBlocks IDE(图形化编程环境) MicroBlocks libra" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/microblocks-dev-notes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-12-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-12-01T00:00:00+00:00" />

<meta itemprop="name" content="MicroBlocks 开发笔记">
<meta itemprop="description" content="前言 记录我在开发 MicroBlocks 过程中积累的知识和技巧。 主要分为三个部分: MicroBlocks library(积木库) MicroBlocks VM(虚拟机) MicroBlocks IDE(图形化编程环境) MicroBlocks libra"><meta itemprop="datePublished" content="2023-12-01T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-12-01T00:00:00+00:00" />
<meta itemprop="wordCount" content="3644">
<meta itemprop="keywords" content="MicroBlocks," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MicroBlocks 开发笔记"/>
<meta name="twitter:description" content="前言 记录我在开发 MicroBlocks 过程中积累的知识和技巧。 主要分为三个部分: MicroBlocks library(积木库) MicroBlocks VM(虚拟机) MicroBlocks IDE(图形化编程环境) MicroBlocks libra"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">夜行人</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/post/%E9%9A%8F%E7%AC%94/aboutme/">
        <li class="mobile-menu-item">About-Me</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">夜行人</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/%E9%9A%8F%E7%AC%94/aboutme/">About-Me</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">MicroBlocks 开发笔记</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-12-01 </span>
        <div class="post-category">
            <a href="/categories/%E7%BC%96%E7%A8%8B/"> 编程 </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#microblocks-library积木库">MicroBlocks library(积木库)</a></li>
    <li><a href="#microblocks-vm虚拟机">MicroBlocks VM(虚拟机)</a>
      <ul>
        <li><a href="#预编译固件">预编译固件</a></li>
        <li><a href="#开发与调试">开发与调试</a>
          <ul>
            <li><a href="#platformio">PlatformIO</a></li>
            <li><a href="#cc-编程环境">C/C++ 编程环境</a>
              <ul>
                <li><a href="#新建-platformio-项目">新建 PlatformIO 项目</a></li>
                <li><a href="#快速行动">快速行动</a></li>
              </ul>
            </li>
            <li><a href="#输出调试信息">输出调试信息</a></li>
            <li><a href="#断点调试">断点调试</a></li>
            <li><a href="#数据类型">数据类型</a>
              <ul>
                <li><a href="#stdstring-与-char-之间的转化">std::string 与 char* 之间的转化</a></li>
                <li><a href="#obj">OBJ</a></li>
              </ul>
            </li>
            <li><a href="#常用技巧">常用技巧</a>
              <ul>
                <li><a href="#默认参数">默认参数</a></li>
                <li><a href="#虚拟机状态">虚拟机状态</a></li>
                <li><a href="#动态创建-list">动态创建 List</a></li>
                <li><a href="#在-ide-与-vm-之间传递数据">在 IDE 与 VM 之间传递数据</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#faq">FAQ</a>
          <ul>
            <li><a href="#arduino-语言使用哪个-c-标准">Arduino 语言使用哪个 C++ 标准？</a></li>
            <li><a href="#合并-esp32-固件">合并 esp32 固件</a></li>
            <li><a href="#microblocks-的速度">MicroBlocks 的速度</a></li>
            <li><a href="#如何显示中文">如何显示中文</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#microblocks-ide图形化编程环境">MicroBlocks IDE(图形化编程环境)</a>
      <ul>
        <li><a href="#开发模式">开发模式</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="前言">前言</h1>
<p>记录我在开发 MicroBlocks 过程中积累的知识和技巧。</p>
<p>主要分为三个部分:</p>
<ul>
<li>MicroBlocks library(积木库)</li>
<li>MicroBlocks VM(虚拟机)</li>
<li>MicroBlocks IDE(图形化编程环境)</li>
</ul>
<h1 id="microblocks-library积木库">MicroBlocks library(积木库)</h1>
<p>创建新的 library , 是<a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/new-device-microblocks-library/">将新设备引入 MicroBlocks</a> 最简单也最常见的方法。</p>
<p>无需进入系统的&quot;下一层&quot;, 一切工作都可以通过拼搭积木来完成。</p>
<!--
菜单需要在代码中做
-->
<h1 id="microblocks-vm虚拟机">MicroBlocks VM(虚拟机)</h1>
<p><a href="https://wiki.microblocks.fun/en/virtual_machine">MicroBlocks wiki</a> 对 MicroBlocks 虚拟机的解释:</p>
<blockquote>
<p>MicroBlocks 代码由运行在微控制器板上的简单解释器或虚拟机(VM)执行。</p>
</blockquote>
<p>如果我们需要为 MicroBlocks 引入新的原语(primitives), 就需要修改<a href="https://bitbucket.org/john_maloney/smallvm/src/master/vm/">虚拟机相关的代码</a>。如我们之前引入 <a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/microblocks-mqtt-library/">MQTT 相关的原语</a>。</p>
<blockquote>
<p>MicroBlocks 虚拟机通过简单的串行协议与IDE或其他类型的软件(如Mozilla物联网网关)进行通信。</p>
</blockquote>
<p><a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/microblocks-interoperability/">MicroBlocks 与其他编程语言的互操作</a> 也是通过上述<a href="https://bitbucket.org/john_maloney/smallvm/src/master/misc/SERIAL_PROTOCOL.md">串行协议</a>实现。</p>
<!--
John Maloney 可能很快会实现该串行协议的BLE版本。
-->
<h2 id="预编译固件">预编译固件</h2>
<p>MicroBlocks IDE 里内置了<a href="https://microblocks.fun/downloads/pilot/vm/">官方维护的固件</a>。通常情况你应该使用这些固件，它们经过了充分的测试。</p>
<p>如果你想使用一些实验阶段的功能, 需要自行编译固件, 或者使用预编译的固件。以下是我预编译的固件:</p>
<!--
使用 https://microblocksfun.cn/run/microblocks.html#project=https://wwj718.github.io/post/img/test-url-load.ubp
-->
<ul>
<li>esp32-octo: 与 OctoStudio 通信。
<ul>
<li>在不低于<strong>v1.2.51</strong>版本的 MicroBlocks 中, OctoStudio 库是开箱可用的</li>
<li>相关教程: <a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/microblocks-octostudio/">MicroBlocks ❤️ OctoStudio: 将手机用作 MicroBlocks 的传感器与执行器</a>
<ul>
<li><a href="https://microblocksfun.cn/run/microblocks.html#project=https://wwj718.github.io/post/img/OctoStudio-Demo-1-0.ubp">示例项目</a></li>
</ul>
</li>
</ul>
</li>
<li>esp32-ble-keyboard: 模拟蓝牙键盘
<ul>
<li>url 地址: <code>https://wwj718.github.io/post/img/esp32-ble-keyboard-20231118.bin</code></li>
<li>相关教程: <a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/microblocks-wireless-makeymakey/">MicroBlocks 编程案例: 制作无线 Makey Makey</a>
<ul>
<li><a href="https://microblocksfun.cn/run/microblocks.html#project=https://wwj718.github.io/post/img/esp32-ble-keyboard-makeymakey-demo-1-0.ubp">示例项目</a></li>
</ul>
</li>
<li><strong>提醒</strong>: 计算机会记住连接过的蓝牙键盘。如果你刷过这个固件, 以后刷其他固件，可能会无法连接 MicroBlocks IDE, 因为设备被计算机当成了蓝牙键盘. 你需要在计算机中&quot;忘记&quot;这个蓝牙键盘,在 iOS 上是<a href="https://support.apple.com/zh-cn/HT204091">忽略此设备</a></li>
</ul>
</li>
<li>esp32-ble-nus: 提供 BLE UART service 相关原语
<ul>
<li>url 地址: <code>https://wwj718.github.io/post/img/esp32-ble-nus-20231202.bin</code></li>
<li>相关教程: <a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/snap-ble-library/#ble-echo-server">ble-echo-server</a>
<ul>
<li><a href="https://microblocksfun.cn/run/microblocks.html#project=https://wwj718.github.io/post/img/esp32-BLE-UART-demo-1-0.ubp">示例项目</a></li>
</ul>
</li>
</ul>
</li>
<li>esp32-espnow: 提供 espnow 相关原语
<ul>
<li>url 地址: <code>https://wwj718.github.io/post/img/esp32-espnow-20231201.bin</code></li>
<li><a href="https://microblocksfun.cn/run/microblocks.html#project=https://wwj718.github.io/post/img/esp32-espnow-demo-1-0.ubp">示例项目</a></li>
</ul>
</li>
<li>无线编程: <a href="/post/%E7%BC%96%E7%A8%8B/microblocks-wireless-programming">点击这里</a></li>
</ul>
<!-- 

- esp32-artnet: artnet
    -   url 地址: `https://wwj718.github.io/post/img/esp32-artnet-20231201.bin`
    -   缺少示例项目
    -   todo 直接用 UDP 写
-->
<p><a href="https://microblocksfun.cn/run/microblocks.html">在线</a>刷入固件:</p>
<p><img src="/post/img/install-esp-firmware-from-url.png" alt=""></p>
<p>你也可以<a href="https://bitbucket.org/john_maloney/smallvm/src/master/README.md">自行编译固件</a></p>
<h2 id="开发与调试">开发与调试</h2>
<p>MicroBlocks VM 采用 C/C++ 编写。它基于 <a href="https://docs.platformio.org/en/latest/frameworks/arduino.html">Arduino 平台</a>,  <a href="https://platformio.org/install/cli">PlatformIO</a> 是首选的构建工具。</p>
<p><a href="https://bitbucket.org/john_maloney/smallvm/src/master/platformio.ini">platformio.ini</a> 是项目的配置文件, 可以视为构建 VM 的起点。</p>
<h3 id="platformio">PlatformIO</h3>
<p>以下是一些有用的 pio 命令。</p>
<ul>
<li>编译 esp32 固件(<code>[env:esp32]</code>): <code>pio run -e esp32</code></li>
<li>编译并上传固件: <code>pio run -e esp32 -t upload</code></li>
<li>列出支持的板子名称:
<ul>
<li>pio boards ESP32S3</li>
<li>pio boards ESP32</li>
</ul>
</li>
<li>更新工具链: <code>pio pkg update -g -p espressif32</code> (编译esp32-s3时用到)</li>
</ul>
<p>以上操作也可以在 vscode 里做(安装 PlatformIO 插件)</p>
<h3 id="cc-编程环境">C/C++ 编程环境</h3>
<blockquote>
<p>MicroBlocks VM 采用 C/C++ 编写</p>
</blockquote>
<!--
在底层编程
心智模型
    图灵机
        - memory
            -   变量/内存
        - **移动**读写头
            -   控制结构
    大多时间都在操弄内存(int/char/unit8_t/unit_t32)。 然后根据结果移动读写头(控制结构)
        -   其他知识对它们的包装
最小通用工具
    -   c
    -   用好list(也许还有dict?)
        -   使用c++的异构list？
        -   microblocks 提供了 list obj! 
            不能放置 C++ 对象, 只能放置 microblocks 内部对象。 蓝牙扫描结果无法放置
    -   创建结构体数组当 dict 用 PrimitiveSet
-->
<h4 id="新建-platformio-项目">新建 PlatformIO 项目</h4>
<p>当我们为 MicroBlocks VM 引入新功能时, 有时遇到一些棘手的 bug。 我们不知道引起 bug 的原因是新代码本身的问题，还是新代码与旧代码互相影响导致的, 又或者是 MicroBlocks 本身的问题&hellip;</p>
<p>我们有时渴望回退到一个安全的&quot;环境&quot;, 它足够干净和简单, 用于单独测试新的代码。</p>
<p>新建一个 PlatformIO 项目可能是不错的选择。</p>
<p><img src="/post/img/microblocks-dev-notes-01.png" alt=""></p>
<p><img src="/post/img/microblocks-dev-notes-02.png" alt=""></p>
<h4 id="快速行动">快速行动</h4>
<blockquote>
<p>The challenge is not building it but understanding it &ndash; Bret Victor 《Seeing Spaces》</p>
</blockquote>
<p>有动态语言(Python, JavaScript)经验的开发者, 切换到编译型语言时, 通常渴望 REPL(Read-Eval-Print-Loop)。 在 REPL 中我们可以获得<strong>快速的反馈循环</strong>。</p>
<p><strong>快速的反馈循环</strong> 通常能够把我带到心流中。我喜欢各种能够增强<strong>快速的反馈循环</strong>的工作流。</p>
<p>最近我喜欢的一个工作流是:</p>
<ul>
<li>与 ChatGPT 沟通讨论, 让它编写任务代码。</li>
<li>在<a href="https://replit.com/templates">replit</a>中启动一个干净的 C/C++ 编程环境, 将这些代码输入其中, 获得输出或错误</li>
<li>将代码调整到我想要的样子(这个过程可能涉及与 ChatGPT 的多次交流)</li>
<li>将实验过程获得的<strong>见解和代码</strong>, 合并到真实项目里。</li>
</ul>
<p><img src="/post/img/microblocks-dev-notes-03.png" alt=""></p>
<h3 id="输出调试信息">输出调试信息</h3>
<p>类似于 Python 的 <code>print</code>, JavaScript 有 <code>console.log</code>,  C/C++ 一般使用 <code>printf</code> 输出调试信息。 MicroBlocks VM 中使用 <code>sprintf</code>。</p>
<p><code>sprintf</code> 类似于 <code>printf</code> 函数，但它不是将输出发送到标准输出，而是格式化字符串并将其存储在一个字符串缓冲区中。</p>
<p>以下是它的典型用法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#34;Changing server port from %d to %d&#34;</span><span class="p">,</span> <span class="n">serverPort</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">outputString</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://wizardforcel.gitbooks.io/lcthw/content/ex6.html">printf 格式化字符串</a> 的所有功能, 你都可以使用。</p>
<p>MicroBlocks 构建了一些<a href="https://bitbucket.org/john_maloney/smallvm/src/7df01ec56fdbea0f5ce82f7045136a40a09d9a86/vm/mem.c#lines-230">辅助 debug 的函数</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">reportNum</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#34;%s: %d&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">outputString</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">reportHex</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)...</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">reportObj</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">OBJ</span> <span class="n">obj</span><span class="p">)...</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">memDumpObj</span><span class="p">(</span><span class="n">OBJ</span> <span class="n">obj</span><span class="p">)...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果你使用<a href="https://microblocksfun.cn/run/microblocks.html">浏览器 MicroBlocks</a>连接板子，输出的信息可以在<a href="https://developer.chrome.com/docs/devtools/console/">浏览器调试工具</a>里查看。</p>
<h3 id="断点调试">断点调试</h3>
<p>ESP32-S3 内置 JTAG 调试接口</p>
<ul>
<li><a href="https://community.platformio.org/t/how-to-use-jtag-built-in-debugger-of-the-esp32-s3-in-platformio/36042">How to use JTAG built-in debugger of the ESP32-S3 in PLATFORMIO</a></li>
<li><a href="https://warped3.substack.com/p/how-to-debug-esp32s3-devkitc-1-using">How to debug ESP32S3 DevKitC-1 using built in JTAG with PlatformIO and VS Code</a></li>
</ul>
<!--
todo

在 VM 和 IDE 之间运送数据

    蓝牙开发 bytearray

    字符串列表 扫描结果
        参考 http response 有多个结构, 字符串

Obj 数据类型
    例子 蓝牙 client 整数或字符串
-->
<h3 id="数据类型">数据类型</h3>
<h4 id="stdstring-与-char-之间的转化">std::string 与 char* 之间的转化</h4>
<p>MicroBlocks 内置的字符串使用 <code>char*</code> (如 <code>obj2str(args[0])</code>), Arduino 生态里的许多库的字符串使用 <code>std::string</code> (如 NimBLE 库)。</p>
<p>经常需要在两者之间转化。 MicroBlocks 偏好在内部使用 C 风格的字符串。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// std::string -&gt; char*
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&#34;Hello World&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cstr</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// char* -&gt; std::string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cstr</span> <span class="o">=</span> <span class="s">&#34;Hello World&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span><span class="p">(</span><span class="n">cstr</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>比较两个字符串是否相等</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 比较 C 风格的字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cstr1</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cstr2</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ref: dataPrims.c/matches
</span></span></span><span class="line"><span class="cl"><span class="c1">//  strcmp 比较两个 C 风格的字符串, 如果字符串相等，strcmp 将返回 0
</span></span></span><span class="line"><span class="cl"><span class="c1">//  strcmp 大小写敏感, strcasecmp 大小写不敏感
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">printf</span><span class="p">(</span><span class="s">&#34;Result: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">cstr1</span><span class="p">,</span> <span class="n">cstr2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// 1 表示 true, 0 表示 false
</span></span></span><span class="line"><span class="cl"><span class="c1">// Result: 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 比较 std::string 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str1</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str2</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 使用 == 比较 std::string 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">printf</span><span class="p">(</span><span class="s">&#34;Result: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">str1</span> <span class="o">==</span> <span class="n">str2</span><span class="p">);</span> <span class="c1">// 1 表示 true, 0 表示 false
</span></span></span><span class="line"><span class="cl"><span class="c1">// Result: 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 检查 str 是否以 prefix 开始, str 比 prefix 短, 不会出错
</span></span></span><span class="line"><span class="cl"><span class="c1">// strncasecmp 大小写不敏感
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&#34;Hello World&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">startsWith</span> <span class="o">=</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="s">&#34;Result: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">startsWith</span><span class="p">);</span> <span class="c1">// 1 表示 true, 0 表示 false
</span></span></span><span class="line"><span class="cl"><span class="c1">// Result: 1
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="obj">OBJ</h4>
<p>动态性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// ref: primBLEPressKey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">OBJ</span> <span class="n">key</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// accept both characters and ASCII values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">IS_TYPE</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">StringType</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bleKeyboard</span><span class="p">.</span><span class="n">press</span><span class="p">(</span><span class="n">obj2str</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isInt</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bleKeyboard</span><span class="p">.</span><span class="n">press</span><span class="p">(</span><span class="n">obj2int</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="常用技巧">常用技巧</h3>
<h4 id="默认参数">默认参数</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// ref: primBLE_UART_Start
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">argCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">obj2str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">:</span> <span class="s">&#34;NimBLE UART&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><!--
对象

字节对象

双向数据传递
-->
<h4 id="虚拟机状态">虚拟机状态</h4>
<p>MicroBlocks 虚拟机是<strong>有状态</strong>的。</p>
<p>MicroBlocks IDE 的<strong>停止按钮</strong>不会重置虚拟机。<strong>停止按钮</strong>会重置 MicroBlocks IDE 的所有变量。</p>
<p>这和 Scratch/Snap 虚拟机的行为是一致的。<strong>停止按钮</strong> 不会重置 Scratch/Snap 虚拟机。你可以做以下实验: 将角色拖拽到任意位置，点击<strong>停止按钮</strong>, 角色不会被重置到舞台中心。</p>
<p>要重置虚拟机, 只能重启微控制器。</p>
<p>以下代码展示了在虚拟机中维护<strong>状态</strong>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// ref: initBLEKeyboard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">bleKeyboardInitialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initBLEKeyboard</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bleKeyboardInitialized</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">bleKeyboard</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="c1">// name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">bleKeyboardInitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="动态创建-list">动态创建 List</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// primMakeList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">OBJ</span> <span class="nf">primMakeList</span><span class="p">(</span><span class="kt">int</span> <span class="n">argCount</span><span class="p">,</span> <span class="n">OBJ</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">OBJ</span> <span class="n">result</span> <span class="o">=</span> <span class="n">newObj</span><span class="p">(</span><span class="n">ListType</span><span class="p">,</span> <span class="n">argCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">falseObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="k">return</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// allocation failed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">FIELD</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">int2obj</span><span class="p">(</span><span class="n">argCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">FIELD</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="在-ide-与-vm-之间传递数据">在 IDE 与 VM 之间传递数据</h4>
<p>常用的数据类型有:</p>
<ul>
<li>Int</li>
<li>String</li>
<li>ByteArray</li>
<li>List (接受不同类型的数据)</li>
</ul>
<details>
  <summary>▶️ IDE -> VM(点击展开)</summary>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// ref: primUDPSendPacket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">OBJ</span> <span class="nf">primUDPSendPacket</span><span class="p">(</span><span class="kt">int</span> <span class="n">argCount</span><span class="p">,</span> <span class="n">OBJ</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">NO_WIFI</span><span class="p">())</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">noWiFi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isConnectedToWiFi</span><span class="p">())</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">wifiNotConnected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">argCount</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">notEnoughArguments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">OBJ</span> <span class="n">data</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">ipAddr</span> <span class="o">=</span> <span class="n">obj2str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">evalInt</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">falseObj</span><span class="p">;</span> <span class="c1">// bad port number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">udp</span><span class="p">.</span><span class="n">beginPacket</span><span class="p">(</span><span class="n">ipAddr</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">isInt</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">udp</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">obj2int</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isBoolean</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">udp</span><span class="p">.</span><span class="n">print</span><span class="p">((</span><span class="n">trueObj</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;true&#34;</span> <span class="o">:</span> <span class="s">&#34;false&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">StringType</span> <span class="o">==</span> <span class="n">TYPE</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">obj2str</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">udp</span><span class="p">.</span><span class="n">write</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ByteArrayType</span> <span class="o">==</span> <span class="n">TYPE</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">udp</span><span class="p">.</span><span class="n">write</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">HEADER_WORDS</span><span class="p">],</span> <span class="n">BYTES</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">udp</span><span class="p">.</span><span class="n">endPacket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">falseObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// primWebSocketSendToClient
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">OBJ</span> <span class="nf">primWebSocketSendToClient</span><span class="p">(</span><span class="kt">int</span> <span class="n">argCount</span><span class="p">,</span> <span class="n">OBJ</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">argCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">notEnoughArguments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">NO_WIFI</span><span class="p">())</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">noWiFi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">clientID</span> <span class="o">=</span> <span class="n">obj2int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">StringType</span> <span class="o">==</span> <span class="n">objType</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">obj2str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="n">websocketServer</span><span class="p">.</span><span class="n">sendTXT</span><span class="p">(</span><span class="n">clientID</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ByteArrayType</span> <span class="o">==</span> <span class="n">objType</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">FIELD</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">websocketServer</span><span class="p">.</span><span class="n">sendBIN</span><span class="p">(</span><span class="n">clientID</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">BYTES</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">falseObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></details>
<details>
  <summary>▶️ VM -> IDE(点击展开)</summary>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// ref: primUDPReceivePacket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">OBJ</span> <span class="nf">primUDPReceivePacket</span><span class="p">(</span><span class="kt">int</span> <span class="n">argCount</span><span class="p">,</span> <span class="n">OBJ</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">NO_WIFI</span><span class="p">())</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">noWiFi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isConnectedToWiFi</span><span class="p">())</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">wifiNotConnected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">useBinary</span> <span class="o">=</span> <span class="p">((</span><span class="n">argCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">trueObj</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">byteCount</span> <span class="o">=</span> <span class="n">udp</span><span class="p">.</span><span class="n">parsePacket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byteCount</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="n">OBJ</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">noDataString</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">OBJ</span> <span class="n">result</span> <span class="o">=</span> <span class="n">falseObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">useBinary</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">result</span> <span class="o">=</span> <span class="n">newObj</span><span class="p">(</span><span class="n">ByteArrayType</span><span class="p">,</span> <span class="p">(</span><span class="n">byteCount</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">falseObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">IS_TYPE</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ByteArrayType</span><span class="p">))</span> <span class="n">setByteCountAdjust</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">byteCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">result</span> <span class="o">=</span> <span class="n">newString</span><span class="p">(</span><span class="n">byteCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">falseObj</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// allocation failed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">udp</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span> <span class="c1">// discard packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">OBJ</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">noDataString</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">udp</span><span class="p">.</span><span class="n">read</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">FIELD</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">byteCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// primWebSocketLastEvent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">webSocketEventCallback</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">WStype_t</span> <span class="n">type</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">websocketEvtType</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">websocketClientId</span> <span class="o">=</span> <span class="n">client_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">websocketPayloadLength</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">websocketPayloadLength</span> <span class="o">&gt;</span> <span class="n">WEBSOCKET_MAX_PAYLOAD</span><span class="p">)</span> <span class="n">websocketPayloadLength</span> <span class="o">=</span> <span class="n">WEBSOCKET_MAX_PAYLOAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">websocketPayload</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">websocketPayloadLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">OBJ</span> <span class="nf">primWebSocketLastEvent</span><span class="p">(</span><span class="kt">int</span> <span class="n">argCount</span><span class="p">,</span> <span class="n">OBJ</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">NO_WIFI</span><span class="p">())</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">noWiFi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">websocketServer</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">websocketEvtType</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">tempGCRoot</span> <span class="o">=</span> <span class="n">newObj</span><span class="p">(</span><span class="n">ListType</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">zeroObj</span><span class="p">);</span> <span class="c1">// use tempGCRoot in case of GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tempGCRoot</span><span class="p">)</span> <span class="k">return</span> <span class="n">falseObj</span><span class="p">;</span> <span class="c1">// allocation failed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">FIELD</span><span class="p">(</span><span class="n">tempGCRoot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">int2obj</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">FIELD</span><span class="p">(</span><span class="n">tempGCRoot</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">int2obj</span><span class="p">(</span><span class="n">websocketEvtType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">FIELD</span><span class="p">(</span><span class="n">tempGCRoot</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">int2obj</span><span class="p">(</span><span class="n">websocketClientId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">WStype_TEXT</span> <span class="o">==</span> <span class="n">websocketEvtType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FIELD</span><span class="p">(</span><span class="n">tempGCRoot</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">newStringFromBytes</span><span class="p">(</span><span class="n">websocketPayload</span><span class="p">,</span> <span class="n">websocketPayloadLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">wordCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">websocketPayloadLength</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">FIELD</span><span class="p">(</span><span class="n">tempGCRoot</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">newObj</span><span class="p">(</span><span class="n">ByteArrayType</span><span class="p">,</span> <span class="n">wordCount</span><span class="p">,</span> <span class="n">falseObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">OBJ</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">FIELD</span><span class="p">(</span><span class="n">tempGCRoot</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">payload</span><span class="p">)</span> <span class="k">return</span> <span class="n">fail</span><span class="p">(</span><span class="n">insufficientMemoryError</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FIELD</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">websocketPayload</span><span class="p">,</span> <span class="n">websocketPayloadLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">setByteCountAdjust</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">websocketPayloadLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">websocketEvtType</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">tempGCRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">falseObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></details>
<h2 id="faq">FAQ</h2>
<h3 id="arduino-语言使用哪个-c-标准">Arduino 语言使用哪个 C++ 标准？</h3>
<blockquote>
<p>Arduino 平台主要使用一种简化的 C++ 版本，它是标准 C++ 的一个子集。Arduino 的开发环境基于 <a href="https://wiring.org.co/">Wiring</a> 语言，这本身是基于 C/C++ 的 &ndash; ChatGPT</p>
</blockquote>
<blockquote>
<p>AVR 核心使用 GCC 7.3.0, 并默认配置为使用 gnu++11 标准 &ndash; <a href="https://arduino.stackexchange.com/questions/86242/which-c-standard-does-the-arduino-language-support">Which C++ standard does the Arduino language support?</a></p>
</blockquote>
<h3 id="合并-esp32-固件">合并 esp32 固件</h3>
<p><strong>提醒: 只测试过 esp32-wroom-32 模组</strong></p>
<p>使用 <code>pio run -e esp32</code> 编译出的固件(位置在<code>.pio/build/esp32/firmware.bin</code>), 无法使用 <a href="https://esp.huhn.me/">ESPWebTool</a>, esptool 等工具烧录到板子, 因为它并不完整。</p>
<p>如果你想使用使用 MicroBlocks 之外的工具烧录它，需要先合并固件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 安装 esptool.py</span>
</span></span><span class="line"><span class="cl">python -m pip install esptool
</span></span><span class="line"><span class="cl"><span class="c1"># 进入 smallvm 目录</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> smallvm
</span></span><span class="line"><span class="cl"><span class="c1"># 编译固件</span>
</span></span><span class="line"><span class="cl">pio run -e esp32
</span></span><span class="line"><span class="cl"><span class="c1"># 合并为单一固件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">esptool.py --chip ESP32 merge_bin -o merged-flash.bin --flash_mode dio --flash_size 4MB 0x1000 esp32/bootloader_dio_40m.bin 0x8000 esp32/partitions2MB.bin 0xe000 esp32/boot_app0.bin 0x10000 .pio/build/esp32/firmware.bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># bootloader_s3.bin</span>
</span></span></code></pre></td></tr></table>
</div>
</div><!--
s3
esptool.py --chip ESP32 merge_bin -o merged-flash.bin --flash_mode dio --flash_size 4MB 0x1000 esp32/bootloader_s3.bin 0x8000 esp32/partitionsMicroBlocks.bin 0xe000 esp32/boot_app0.bin 0x10000 .pio/build/esp32/firmware.bin
-->
<p>然后就可以使用其他工具烧录合并后的 <code>merged-flash.bin</code> 固件了。</p>
<h3 id="microblocks-的速度">MicroBlocks 的速度</h3>
<p>@曾祥潘 老师分别测试了 Arduino、MicroBlocks、MiroPython 翻转 rpi pico 引脚的速度, MicroBlocks 的速度大约是MiroPython的 3 倍左右。以下是测试结果:</p>
<ul>
<li>Arduino: 885 kHz</li>
<li>MicroBlocks: 251.67 kHz</li>
<li>MiroPython: 88.83 kHz</li>
</ul>
<p><img src="/post/img/microblocks-dev-notes-04.png" alt=""></p>
<p>MicroBlocks 可以在 4 us(微秒)(1000,000 us/250,000 Hz)里完成一次引脚切换循环。这使得它可以支持一些要求严苛的应用, 诸如<a href="https://blog.chybby.com/posts/building-a-usb-snes-controller">接管任天堂 SNES 控制器</a>(需要能够工作在 6us 时间尺度里)。</p>
<!--
如果把 miciroblocks  高低电平持续时间比例视为 1:2, 那么单条代码运行时间为 1/3 x 4 =  1.3 us，似乎比1:2多些， 所以估计单条代码运行时间 1.5 us，循环本身消耗时间 1us
MicroBlocks 单条指令似乎在 4
-->
<!--
1s = 1000ms = 1000,000 us
250 000 hz

4us 翻转一次?

MicroBlocks 的运行尺度

https://blog.chybby.com/posts/building-a-usb-snes-controller 应该可以接管 USB SNES 控制器
-->
<h3 id="如何显示中文">如何显示中文</h3>
<p>参考 @Bingo 的视频分享 <a href="https://www.bilibili.com/video/BV1Ge41127Wu">利用 MicroBlocks 在掌控板中显示汉字</a></p>
<p>@Bingo 分享了生成字库的 16 进制字符串的 Python 脚本: <a href="/post/img/HexStr.py">HexStr.py</a> (使用方法参考前边视频的<a href="https://www.bilibili.com/video/BV1Ge41127Wu?t=188.9">这个片段</a>)。 @Bingo  提醒也可以用 PCtoLCD 软件生成。</p>
<p>以上方法也可用于显示 emoji: <a href="/post/img/HexStr_emoji.py">HexStr_emoji.py</a>, 至于 MicroBlocks 方面，复用 @Bingo 提交的 <code>OLED 汉字</code>库即可(已内置在最新中文版本里)。需要注意的是, 在 MicroBlocks 中尽量手动输入 emoji 字符, 复制粘贴可能会有问题。</p>
<p><img src="/post/img/microblocks-emoji.jpeg" alt=""></p>
<!--emoji?
https://github.com/longan-link/dotpack_pyclient/blob/main/dotpack/ledbag.py#L306
-->
<h1 id="microblocks-ide图形化编程环境">MicroBlocks IDE(图形化编程环境)</h1>
<p>MicroBlocks IDE 基于 <a href="https://gpblocks.org/">GP Blocks</a> 构建。 相关代码<a href="https://bitbucket.org/john_maloney/smallvm/src/master/ide/">在这儿</a>。 通常情况下, 很少需要修改 MicroBlocks IDE。</p>
<p>我们之前在<a href="https://www.bilibili.com/video/BV19R4y1q7XH/">这个视频</a>里讨论 MicroBlocks IDE 相关话题。</p>
<p>GP Blocks 目前还没有做到 <a href="https://squeak.org/">Squeak</a> 那种程度的自支持(我之前在邮件中和John Maloney确认过)。MicroBlocks IDE 的开发过程依然在代码中进行, Morphic 环境主要用于探索和实验。</p>
<!--
使用笔记
## 一些实用库
wifi radio
serial python
ble uart client
snap ...
-->
<h2 id="开发模式">开发模式</h2>
<p>进入开发模式, 可以方便调试 morphic</p>
<p><code>./build.sh --dev</code></p>
<p>在 MacOS 下从浏览器 MicroBlocks 进入开发模式: <code>shift + option + click</code></p>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://wwj718.github.io/">我的博客</a>
<ul>
<li><a href="https://wwj718.github.io/tags/microblocks/">wwj718 blog tags: microblocks</a></li>
<li><a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/new-device-microblocks-library/">将新设备引入 MicroBlocks</a></li>
<li><a href="https://www.bilibili.com/video/BV19R4y1q7XH/">MicroBlocks 社区分享会回放 MicroBlocks IDE 探秘</a></li>
<li><a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/microblocks-interoperability/">MicroBlocks 与其他编程语言的互操作</a></li>
<li><a href="https://wwj718.github.io/post/%E7%BC%96%E7%A8%8B/microblocks-mqtt-library/">MicroBlocks 编程案例: MQTT 库</a></li>
</ul>
</li>
<li><a href="https://wiki.microblocks.fun/en/home">MicroBlocks wiki</a>
<ul>
<li><a href="https://wiki.microblocks.fun/en/virtual_machine">The MicroBlocks Virtual Machine</a>
<ul>
<li><a href="https://bitbucket.org/john_maloney/smallvm/src/master/misc/SERIAL_PROTOCOL.md">Microblocks Serial Protocol (version 2.09)</a></li>
<li><a href="https://bitbucket.org/john_maloney/smallvm/src/master/vm/">MicroBlocks vm code</a>
<ul>
<li><a href="https://bitbucket.org/john_maloney/smallvm/src/7df01ec56fdbea0f5ce82f7045136a40a09d9a86/vm/mem.c#lines-230">辅助 debug 的函数</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://wiki.microblocks.fun/en/microblocks_ide_implementation">The MicroBlocks IDE</a>
<ul>
<li><a href="https://bitbucket.org/john_maloney/smallvm/src/master/ide/">MicroBlocks IDE code</a></li>
</ul>
</li>
<li><a href="https://wiki.microblocks.fun/en/gp_syntax">GP Syntax</a>
<ul>
<li><a href="https://gpblocks.org/">GP Blocks</a>
<ul>
<li><a href="https://bitbucket.org/john_maloney/gp/src">gp repo</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://wiki.microblocks.fun/en/boards/full_board_list">community supported boards</a></li>
<li><a href="https://wiki.microblocks.fun/en/boards/special_pins">Special Pins</a></li>
<li><a href="https://wiki.microblocks.fun/en/howto/run_vm_on_raspberry_pi">Running the MicroBlocks VM on a Raspberry Pi</a></li>
</ul>
</li>
<li>C/C++
<ul>
<li><a href="https://wizardforcel.gitbooks.io/lcthw/content/">笨办法学C 中文版</a></li>
<li><a href="https://learnxinyminutes.com/docs/zh-cn/c-cn/">learnxinyminutes C</a></li>
<li><a href="https://learnxinyminutes.com/docs/zh-cn/c++-cn/">learnxinyminutes C++</a></li>
<li><a href="https://cheatography.com/ashlyn-black/cheat-sheets/c-reference/">C Reference Cheat Sheet</a></li>
<li><a href="https://replit.com/">replit c/c++ env</a></li>
<li><a href="https://www.thecodedmessage.com/posts/endianness/">Endianness, and why I don’t like htons(3) and friends</a></li>
<li><a href="https://wiring.org.co/reference/">wiring/reference</a></li>
</ul>
</li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">种瓜</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-12-01
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/microblocks/">MicroBlocks</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E7%BC%96%E7%A8%8B/squeakjs-scratch14/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">浏览器中的 Scratch 1.4</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E7%BC%96%E7%A8%8B/scratch-link-extensions-to-snap/">
            <span class="next-text nav-default">将基于 Scratch Link 的插件迁移到 Snap!</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:wuwenjie718@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="mailto:wuwenjie718@gmail.com" class="iconfont icon-out-me" title="out-me"></a>
      <a href="https://github.com/wwj718" class="iconfont icon-github" title="github"></a>
  <a href="http://wwj718.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  
  <span><a target="_blank" href="https://cn.bing.com/search?q=site%3Awwj718.github.io%20%20codelab-adapter">搜索本站</a></span>
  <span class="division">|</span>
  <span><a target="_blank" href="/index.xml">RSS订阅</a></span>
  <span class="division">|</span>
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2013 - 
    2024<span class="heart"><i class="iconfont icon-heart"></i></span><span>种瓜</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="/post/img/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="/post/img/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="/post/img/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?18db4b662c04fbd6cc2851d246c51b3f";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
